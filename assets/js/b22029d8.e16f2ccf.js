"use strict";(self.webpackChunkayon_docs=self.webpackChunkayon_docs||[]).push([[926],{4137:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},s=Object.keys(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=i.createContext({}),p=function(e){var t=i.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=p(e.components);return i.createElement(o.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,o=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),d=p(n),m=a,h=d["".concat(o,".").concat(m)]||d[m]||c[m]||s;return n?i.createElement(h,l(l({ref:t},u),{},{components:n})):i.createElement(h,l({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,l=new Array(s);l[0]=m;var r={};for(var o in t)hasOwnProperty.call(t,o)&&(r[o]=t[o]);r.originalType=e,r[d]="string"==typeof e?e:a,l[1]=r;for(var p=2;p<s;p++)l[p]=n[p];return i.createElement.apply(null,l)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6439:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>c,frontMatter:()=>s,metadata:()=>r,toc:()=>p});var i=n(7462),a=(n(7294),n(4137));const s={id:"dev_testing",title:"Testing in AYON",sidebar_label:"Testing"},l=void 0,r={unversionedId:"dev_testing",id:"dev_testing",title:"Testing in AYON",description:"Introduction",source:"@site/docs/dev_testing.md",sourceDirName:".",slug:"/dev_testing",permalink:"/ayon-documentation/docs/dev_testing",draft:!1,editUrl:"https://github.com/ynput/ayon-documentation/tree/main/website/docs/dev_testing.md",tags:[],version:"current",frontMatter:{id:"dev_testing",title:"Testing in AYON",sidebar_label:"Testing"},sidebar:"Dev",previous:{title:"Developer mode",permalink:"/ayon-documentation/docs/dev_dev_mode"},next:{title:"Contribute",permalink:"/ayon-documentation/docs/dev_contribute"}},o={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Integration tests",id:"integration-tests",level:3},{value:"Requirements",id:"requirements",level:4},{value:"Publishing tests",id:"publishing-tests",level:4},{value:"Preparation",id:"preparation",level:5},{value:"Launch of application and publish",id:"launch-of-application-and-publish",level:5},{value:"Comparison of results",id:"comparison-of-results",level:5},{value:"Cleanup",id:"cleanup",level:5},{value:"Unit tests",id:"unit-tests",level:3},{value:"Content of tests folder",id:"content-of-tests-folder",level:2},{value:"<code>lib</code> folder",id:"lib-folder",level:3},{value:"<code>integration</code> folder",id:"integration-folder",level:3}],u={toc:p},d="wrapper";function c(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,i.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"As AYON is growing there also grows need for automatic testing. AYON Server API has its own test suite - ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/ynput/ayon-tests"},"github.com/ynput/ayon-tests"),". For AYON Desktop there are already bunch of tests present in test folder of AYON directory. Apart of unit testing there are also integration tests that mimics real production usage and are able to test whole workflows."),(0,a.kt)("admonition",{title:"Tests are Work In Progress",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"We are now in heavy effort to add more integration tests and\nenhance the whole experience of writing and executing tests.")),(0,a.kt)("h3",{id:"integration-tests"},"Integration tests"),(0,a.kt)("admonition",{title:"Integration tests and OpenPype mode",type:"warning"},(0,a.kt)("p",{parentName:"admonition"},"Integration tests currently work only in ",(0,a.kt)("strong",{parentName:"p"},"OpenPype")," mode (MongoDB),\nnot with ",(0,a.kt)("strong",{parentName:"p"},"AYON")," server.")),(0,a.kt)("h4",{id:"requirements"},"Requirements"),(0,a.kt)("p",null,"Tests are recreating fresh DB for each run, so ",(0,a.kt)("strong",{parentName:"p"},"mongorestore"),", ",(0,a.kt)("strong",{parentName:"p"},"mongodump")," and ",(0,a.kt)("strong",{parentName:"p"},"mongoimport")," command line tools must be installed and in ",(0,a.kt)("inlineCode",{parentName:"p"},"PATH"),"."),(0,a.kt)("p",null,"You can find installers here: ",(0,a.kt)("a",{parentName:"p",href:"https://www.mongodb.com/docs/database-tools/installation/installation/"},"https://www.mongodb.com/docs/database-tools/installation/installation/")),(0,a.kt)("p",null,"You could check that ",(0,a.kt)("strong",{parentName:"p"},"mongorestore")," is available by running this in shell, it shouldn't fail and you should see version of the utility:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"mongorestore --version\n")),(0,a.kt)("p",null,"If you would like just to experiment with provided integration tests, and have particular DCC installed on your machine, you could run test for this host by:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"}," ./.poetry/bin/poetry run python start.py runtests ./tests/integration/hosts/nuke\n")),(0,a.kt)("p",null,"You can modify tests path argument to limit which tests should be run (otherwise ",(0,a.kt)("inlineCode",{parentName:"p"},"./tests/integration")," will run all implemented integration tests)."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"runtests")," command accepts following arguments:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"-m <TEXT>")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"--mark <TEXT>"),": run tests ",(0,a.kt)("a",{parentName:"li",href:"https://docs.pytest.org/en/7.1.x/how-to/mark.html"},"marked")," by ",(0,a.kt)("inlineCode",{parentName:"li"},"<TEXT>")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"-p <TEXT>")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"--pyargs <TEXT>"),": You can use the ",(0,a.kt)("inlineCode",{parentName:"li"},"--pyargs")," option to make test try interpreting arguments as python package names, deriving their file system path and then running the test."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--test_data_folder <PATH>"),": Unzipped directory path of a test file."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"-s")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"--persist"),": Persist the test database and published files after testing."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"-a <TEXT>")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"--app_variant <TEXT>"),": Specific application (host) variant to be used in tests, like ",(0,a.kt)("inlineCode",{parentName:"li"},"maya-2024"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--timeout <SECS>"),": Timeout value in seconds for tests."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"-so")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"--setup_only"),": Only create database, do not run tests.")),(0,a.kt)("p",null,'Integration tests are setup to start DCC application with prepared work file, run publish process and compare results in database and file system automatically.\nThis approach is implemented as it should work in any DCC application and should cover most common use cases. Not all hosts allow "real headless" publishing, but all hosts should allow to trigger publishing process programmatically when UI of the host is actually running.'),(0,a.kt)("p",null,"There will be eventually possibility to build work file and publish it programmatically, this would work only in DCCs that support it (Maya, Nuke, Houdini, ...)."),(0,a.kt)("p",null,"It is expected that each test class should work with single work file with supporting resources (as a dump of project DB, all necessary environment variables, expected published files etc.)"),(0,a.kt)("p",null,"There are currently implemented basic publish tests for ",(0,a.kt)("inlineCode",{parentName:"p"},"Maya"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"Nuke"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"AfterEffects")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"Photoshop"),". Additional hosts will be added."),(0,a.kt)("p",null,"Each ",(0,a.kt)("inlineCode",{parentName:"p"},"test_")," class should contain single test class based on ",(0,a.kt)("inlineCode",{parentName:"p"},"tests.lib.testing_classes.PublishTest"),". This base class handles all necessary functionality for testing in a host application."),(0,a.kt)("h4",{id:"publishing-tests"},"Publishing tests"),(0,a.kt)("p",null,"Each publishing test consists of following phases:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"preparation"),(0,a.kt)("li",{parentName:"ul"},"launch of host application (DCC)"),(0,a.kt)("li",{parentName:"ul"},"publish"),(0,a.kt)("li",{parentName:"ul"},"comparison of results in DB and file system"),(0,a.kt)("li",{parentName:"ul"},"cleanup")),(0,a.kt)("h5",{id:"preparation"},"Preparation"),(0,a.kt)("p",null,"Each publish test case expects zip file with this structure:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"expected")," - published files after work file is published (in same structure as in regular manual publish)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"input"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"dumps")," - database dumps (check ",(0,a.kt)("inlineCode",{parentName:"li"},"tests.lib.db_handler")," for implemented functionality)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"openpype")," - settings"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"test_db")," - skeleton of test project (contains project document, asset document etc.)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"env_vars")," - ",(0,a.kt)("inlineCode",{parentName:"li"},"env_var.json")," file with a dictionary of all required environment variables"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"json")," - json files with human readable content of databases"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"startup")," - any required initialization scripts (for example Nuke requires one ",(0,a.kt)("inlineCode",{parentName:"li"},"init.py")," file)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"workfile")," - contains single work file")))),(0,a.kt)("p",null,"These folders needs to be zipped as zip root. Currently zip files for all prepared tests are stored in AYON GDrive folder."),(0,a.kt)("p",null,"Each test then goes in steps (by default):"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"download test data zip"),(0,a.kt)("li",{parentName:"ul"},"create temporary folder and unzip there data zip file"),(0,a.kt)("li",{parentName:"ul"},"purge test DB if exists, import dump files from unzipped folder"),(0,a.kt)("li",{parentName:"ul"},"sets environment variables from ",(0,a.kt)("inlineCode",{parentName:"li"},"env_vars")," folder"),(0,a.kt)("li",{parentName:"ul"},"launches host application and trigger publish process"),(0,a.kt)("li",{parentName:"ul"},"waits until publish process finishes, application closes (or timeouts)"),(0,a.kt)("li",{parentName:"ul"},"compares results in DB with expected values"),(0,a.kt)("li",{parentName:"ul"},"compares published files structure with expected values"),(0,a.kt)("li",{parentName:"ul"},"cleans up temporary test DB and folder")),(0,a.kt)("h5",{id:"launch-of-application-and-publish"},"Launch of application and publish"),(0,a.kt)("p",null,"Integration tests are using same approach as AYON Desktop process regarding launching of host applications (eg. ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationManager().launch"),').\nEach host application is in charge of triggering of publish process and closing itself. Different hosts handle this differently, Adobe products are handling this via injected "HEADLESS_PUBLISH" environment variable,\nMaya and Nuke must contain this in theirs startup files.'),(0,a.kt)("p",null,"Base ",(0,a.kt)("inlineCode",{parentName:"p"},"PublishTest")," class contains configurable timeout in case of publish process is not working, or taking too long."),(0,a.kt)("h5",{id:"comparison-of-results"},"Comparison of results"),(0,a.kt)("p",null,"Each test class requires re-implemented ",(0,a.kt)("inlineCode",{parentName:"p"},"PublishTest.test_db_asserts")," fixture. This method is triggered after publish is finished and should compare current results in DB (each test has its own database which gets filled with dump data first, cleaned up after test finishing) with expected results."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"tests.lib.assert_classes.py")," contains prepared method ",(0,a.kt)("inlineCode",{parentName:"p"},"count_of_types")," which makes easier to write assert expression. This method also produces formatted error message."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Basic use case:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'DBAssert.count_of_types(dbcon, "version", 2)\n')),(0,a.kt)("p",null,"It is expected that DB contains only 2 documents of ",(0,a.kt)("inlineCode",{parentName:"p"},"type==version")),(0,a.kt)("p",null,"If zip file contains file structure in ",(0,a.kt)("inlineCode",{parentName:"p"},"expected")," folder, ",(0,a.kt)("inlineCode",{parentName:"p"},"PublishTest.test_folder_structure_same")," implements comparison of expected and published file structure,\neg. if test case published all expected files."),(0,a.kt)("h5",{id:"cleanup"},"Cleanup"),(0,a.kt)("p",null,"By default, each test case pulls data from GDrive, unzips them in temporary folder, runs publish, compares results and then\npurges created temporary test database and temporary folder. This could be changed by setting of ",(0,a.kt)("inlineCode",{parentName:"p"},"PublishTest.PERSIST"),". If set to True, DB and published folder are kept intact\nuntil next run of any test."),(0,a.kt)("p",null,"In case you want to modify test data, use ",(0,a.kt)("inlineCode",{parentName:"p"},"PublishTest.TEST_DATA_FOLDER")," to point test to specific location where test folder is already unzipped."),(0,a.kt)("p",null,"Both options are mostly useful for debugging during implementation of new test cases."),(0,a.kt)("h3",{id:"unit-tests"},"Unit tests"),(0,a.kt)("p",null,"Unit tests are in ",(0,a.kt)("inlineCode",{parentName:"p"},"./tests/unit")," folder. THere should be located unit tests for classes, methods of AYON etc. As most classes expect to be triggered in AYON context, best option is to\nstart these tests in similar fashion as ",(0,a.kt)("inlineCode",{parentName:"p"},"integration")," tests (eg. via ",(0,a.kt)("inlineCode",{parentName:"p"},"runtests"),")."),(0,a.kt)("h2",{id:"content-of-tests-folder"},"Content of tests folder"),(0,a.kt)("p",null,"Main tests folder contains hierarchy of folders with tests and supporting lib files. It is intended that tests in each folder of the hierarchy could be run separately."),(0,a.kt)("p",null,"Main folders in the structure:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"integration")," - end to end tests in host applications, mimicking regular publishing process"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"lib")," - helper classes"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"resources")," - test data skeletons etc."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"unit")," - unit test covering methods and functions in OP")),(0,a.kt)("h3",{id:"lib-folder"},(0,a.kt)("inlineCode",{parentName:"h3"},"lib")," folder"),(0,a.kt)("p",null,"This location should contain library of helpers and miscellaneous classes used for integration or unit tests."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Content:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"assert_classes.py")," - helpers for easier use of assert expressions"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"db_handler.py")," - class for creation of DB dumps/restore/purge"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"file_hanlder.py")," - class for preparation/cleanup of test data"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"testing_classes.py")," - base classes for testing of publish in various DCCs")),(0,a.kt)("h3",{id:"integration-folder"},(0,a.kt)("inlineCode",{parentName:"h3"},"integration")," folder"),(0,a.kt)("p",null,"There are host specific test in ",(0,a.kt)("inlineCode",{parentName:"p"},"hosts")," sub-folder."))}c.isMDXComponent=!0}}]);